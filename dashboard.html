<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard V7 - G√≥c Truy·ªán C·ªßa Tui</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .loading { opacity: 0.5; pointer-events: none; }
        .para-row { transition: all 0.1s; cursor: pointer; border-bottom: 1px solid #f1f5f9; }
        .para-row:hover { background-color: #f8fafc; }
        .row-active { background-color: #eff6ff !important; border-left: 4px solid #3b82f6; }
        .row-active .idx { color: #2563eb; font-weight: 800; }
        .cell-empty { background-color: #fef2f2; color: #dc2626; }
        .cell-warning { background-color: #fffbeb; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen p-4 md:p-6 font-sans text-slate-800">

    <div class="max-w-[95rem] mx-auto bg-white rounded-2xl shadow-xl border border-slate-200 p-6 flex flex-col h-[calc(100vh-3rem)]">
        <div class="flex justify-between items-center mb-4 border-b border-slate-100 pb-2 shrink-0">
            <h1 class="text-2xl font-extrabold text-gray-800 flex items-center gap-3">
                üëë Dashboard <span class="text-xs bg-indigo-100 text-indigo-800 px-2 py-1 rounded-full border border-indigo-200">V7.0 Click-to-Scroll</span>
            </h1>
            <button onclick="logout()" class="text-sm text-red-500 hover:text-red-700 font-medium hover:underline">ƒêƒÉng xu·∫•t</button>
        </div>

        <div id="config-section" class="mb-8 hidden max-w-2xl mx-auto">
            <div class="bg-blue-50 p-4 rounded-xl border border-blue-200 mb-6 text-sm text-blue-800 flex items-center gap-2">
                ‚ÑπÔ∏è Nh·∫≠p th√¥ng tin GitHub (Token c·∫ßn quy·ªÅn <code>public_repo</code>).
            </div>
            <div class="space-y-4">
                <input type="text" id="gh-username" class="w-full p-3 border rounded-lg" placeholder="Username">
                <input type="text" id="gh-repo" class="w-full p-3 border rounded-lg" placeholder="Repo">
                <input type="password" id="gh-token" class="w-full p-3 border rounded-lg" placeholder="Token">
                <button onclick="saveConfig()" class="w-full bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 font-bold transition shadow-lg">L∆∞u & K·∫øt n·ªëi</button>
            </div>
        </div>

        <div id="editor-section" class="hidden flex flex-col h-full overflow-hidden">
            <div class="flex flex-wrap gap-3 mb-4 shrink-0 bg-slate-50 p-3 rounded-lg border border-slate-200 items-center">
                <select id="story-folder" class="p-2 border rounded-md text-sm font-medium w-40 focus:border-blue-500 outline-none">
                    <option value="boyfriend-material">Boyfriend Material</option>
                    <option value="the-long-game">The Long Game</option>
                    <option value="the-foxhole-court">The Foxhole Court</option>
                    <option value="the-wolf-at-the-door">The Wolf at the Door</option>
                    <option value="red-white-and-royal-blue">Red, White & Royal Blue</option>
                </select>
                <input type="text" id="story-parent" class="p-2 border rounded-md text-sm w-40 outline-none" placeholder="T√™n truy·ªán...">
                <input type="number" id="chap-num" class="p-2 border rounded-md text-sm w-20 outline-none" placeholder="S·ªë">
                <input type="text" id="chap-title" class="p-2 border rounded-md text-sm flex-1 outline-none" placeholder="Ti√™u ƒë·ªÅ ch∆∞∆°ng...">
                
                <div class="flex items-center gap-3 border-l border-slate-300 pl-3 ml-auto">
                    <label class="inline-flex items-center cursor-pointer select-none">
                        <input type="checkbox" id="bilingual-mode" class="sr-only peer" checked>
                        <div class="w-9 h-5 bg-gray-300 rounded-full peer peer-checked:bg-green-500 relative after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:after:translate-x-full"></div>
                        <span class="ml-2 text-xs font-bold text-slate-600">Song Ng·ªØ</span>
                    </label>
                    <button onclick="toggleChecker()" id="btn-checker" class="hidden items-center gap-1 bg-purple-100 text-purple-700 px-3 py-1.5 rounded-md hover:bg-purple-200 border border-purple-200 text-xs font-bold transition shadow-sm">
                        <span>üîç</span> Soi L·ªói
                    </button>
                    <button id="btn-publish" onclick="publishChapter()" class="bg-blue-600 text-white px-4 py-1.5 rounded-md hover:bg-blue-700 font-bold text-xs shadow-md transition disabled:bg-gray-400 disabled:cursor-not-allowed flex items-center gap-1">
                        <span>üöÄ</span> ƒêƒÉng
                    </button>
                </div>
            </div>

            <div id="smart-alert" class="hidden mb-4 p-3 bg-orange-50 border border-orange-200 rounded-lg text-sm flex items-center justify-between shadow-sm shrink-0">
                <div class="flex items-center gap-2">
                    <span class="text-xl">üßê</span>
                    <span class="text-orange-800" id="smart-alert-msg">Ph√°t hi·ªán ƒëi·ªÉm nghi v·∫•n!</span>
                </div>
                <button onclick="scrollToSuspicious()" class="text-xs bg-white text-orange-700 px-3 py-1 rounded border border-orange-200 hover:bg-orange-100 font-bold">Xem ngay</button>
            </div>

            <div id="checker-area" class="hidden shrink-0 mb-4 h-[45%] border border-indigo-200 rounded-xl overflow-hidden bg-white shadow-lg flex flex-col">
                <div class="p-2 bg-indigo-50 border-b border-indigo-100 flex justify-between items-center shrink-0">
                    <span class="font-bold text-indigo-900 text-xs flex items-center gap-2 px-2">
                        <span>üîé</span> B·∫¢NG SOI L·ªñI (B·∫•m ƒë·ªÉ nh·∫£y t·ªõi ch·ªó s·ª≠a)
                    </span>
                    <button onclick="toggleChecker()" class="text-xs bg-white text-indigo-600 px-2 py-0.5 rounded border border-indigo-200 hover:bg-indigo-600 hover:text-white transition">ƒê√≥ng</button>
                </div>
                <div class="grid grid-cols-2 bg-indigo-100/50 text-[10px] font-bold text-indigo-800 uppercase tracking-wide border-b border-indigo-100 shrink-0">
                    <div class="p-2 pl-4">Ti·∫øng Vi·ªát</div>
                    <div class="p-2 pl-4 border-l border-indigo-100">Ti·∫øng Anh</div>
                </div>
                <div id="checker-content" class="flex-1 overflow-y-auto bg-white"></div>
            </div>

            <div class="flex-1 grid grid-cols-1 md:grid-cols-2 gap-4 min-h-0" id="input-grid">
                <div class="flex flex-col h-full group">
                    <div class="flex justify-between mb-1 px-1 shrink-0">
                        <label class="font-bold text-blue-800 text-xs flex items-center gap-1">üáªüá≥ Ti·∫øng Vi·ªát</label>
                        <span class="text-[10px] font-mono font-bold text-white bg-blue-500 px-2 rounded-full" id="count-vi">0</span>
                    </div>
                    <textarea id="content-vi" class="flex-1 w-full p-4 border border-slate-300 rounded-xl text-sm font-mono leading-relaxed focus:ring-2 focus:ring-blue-500 outline-none resize-none shadow-sm transition" 
                    placeholder="Nh·∫≠p n·ªôi dung Ti·∫øng Vi·ªát..." oninput="handleInput()"></textarea>
                </div>
                
                <div id="col-en" class="flex flex-col h-full group">
                    <div class="flex justify-between mb-1 px-1 shrink-0">
                        <label class="font-bold text-red-800 text-xs flex items-center gap-1">üá∫üá∏ Ti·∫øng Anh</label>
                        <span class="text-[10px] font-mono font-bold text-white bg-red-500 px-2 rounded-full" id="count-en">0</span>
                    </div>
                    <textarea id="content-en" class="flex-1 w-full p-4 border border-slate-300 rounded-xl text-sm font-mono leading-relaxed focus:ring-2 focus:ring-red-500 outline-none resize-none shadow-sm transition" 
                    placeholder="Paste English content here..." oninput="handleInput()"></textarea>
                </div>
            </div>
            
            <div id="status-msg" class="text-center mt-2 text-xs font-mono text-slate-500 shrink-0 h-4"></div>
        </div>
    </div>

    <script>
        const CONFIG_KEY = 'gh_admin_config_v7';
        let config = JSON.parse(localStorage.getItem(CONFIG_KEY)) || {};
        let suspiciousIndex = -1;

        // --- AUTH & CONFIG ---
        function checkAuth() {
            const elConfig = document.getElementById('config-section');
            const elEditor = document.getElementById('editor-section');
            if (config.token && config.user && config.repo) {
                elConfig.classList.add('hidden');
                elEditor.classList.remove('hidden');
                handleInput();
            } else {
                elConfig.classList.remove('hidden');
                elEditor.classList.add('hidden');
            }
        }

        function saveConfig() {
            const user = document.getElementById('gh-username').value.trim();
            const repo = document.getElementById('gh-repo').value.trim();
            const token = document.getElementById('gh-token').value.trim();
            if(!user || !repo || !token) return alert("Nh·∫≠p ƒë·ªß th√¥ng tin ƒëi b·ªì!");
            config = { user, repo, token };
            localStorage.setItem(CONFIG_KEY, JSON.stringify(config));
            checkAuth();
        }

        function logout() {
            if(confirm("ƒêƒÉng xu·∫•t?")) {
                localStorage.removeItem(CONFIG_KEY);
                location.reload();
            }
        }

        // --- CORE LOGIC ---
        function splitParas(text) {
            return text.split(/\n+/).map(p => p.trim()).filter(p => p.length > 0);
        }

        function isSeparator(text) {
            return /^(\*\s*){3,}$/.test(text) || /^(\-\s*){3,}$/.test(text);
        }

        function handleInput() {
            const viVal = document.getElementById('content-vi').value;
            const enVal = document.getElementById('content-en').value;
            const isBilingual = document.getElementById('bilingual-mode').checked;
            const btn = document.getElementById('btn-publish');
            const smartAlert = document.getElementById('smart-alert');
            const smartMsg = document.getElementById('smart-alert-msg');
            
            const parasVi = splitParas(viVal);
            const parasEn = splitParas(enVal);
            
            document.getElementById('count-vi').innerText = parasVi.length;
            document.getElementById('count-en').innerText = parasEn.length;

            let isValid = false;

            if (isBilingual) {
                document.getElementById('btn-checker').classList.remove('hidden');
                
                if (parasVi.length !== parasEn.length && (parasVi.length > 0 || parasEn.length > 0)) {
                    smartAlert.classList.remove('hidden');
                    const diff = Math.abs(parasVi.length - parasEn.length);
                    smartMsg.innerHTML = `L·ªách <b>${diff}</b> ƒëo·∫°n! (Vi·ªát: ${parasVi.length} - Anh: ${parasEn.length})`;
                    
                    suspiciousIndex = Math.min(parasVi.length, parasEn.length);
                    for(let i=0; i < Math.min(parasVi.length, parasEn.length); i++) {
                        if(isSeparator(parasVi[i]) !== isSeparator(parasEn[i])) {
                            suspiciousIndex = i;
                            smartMsg.innerHTML = `L·ªách ·ªü ƒëo·∫°n s·ªë <b>${i+1}</b> (D·∫•u ng·∫Øt c·∫£nh kh√¥ng kh·ªõp).`;
                            break;
                        }
                    }

                    btn.disabled = true;
                    btn.classList.add('bg-gray-400', 'cursor-not-allowed');
                    btn.classList.remove('bg-green-600', 'hover:bg-green-700');
                } else {
                    smartAlert.classList.add('hidden');
                    isValid = (parasVi.length > 0);
                }
            } else {
                document.getElementById('btn-checker').classList.add('hidden');
                smartAlert.classList.add('hidden');
                isValid = (parasVi.length > 0);
            }

            if (isValid) {
                btn.disabled = false;
                btn.classList.remove('bg-gray-400', 'cursor-not-allowed');
                btn.classList.add('bg-green-600', 'hover:bg-green-700');
            }

            if (!document.getElementById('checker-area').classList.contains('hidden')) {
                renderChecker();
            }
        }

        // --- CHECKER & SCROLL TO EDIT (V7) ---
        function toggleChecker() {
            const area = document.getElementById('checker-area');
            area.classList.toggle('hidden');
            if (!area.classList.contains('hidden')) {
                renderChecker();
                if (suspiciousIndex > -1) highlightAndScroll(suspiciousIndex);
            }
        }

        function scrollToSuspicious() {
            const area = document.getElementById('checker-area');
            area.classList.remove('hidden');
            renderChecker();
            highlightAndScroll(suspiciousIndex);
        }

        function renderChecker() {
            const vi = splitParas(document.getElementById('content-vi').value);
            const en = splitParas(document.getElementById('content-en').value);
            const container = document.getElementById('checker-content');
            
            container.innerHTML = "";
            const max = Math.max(vi.length, en.length);

            for (let i = 0; i < max; i++) {
                const row = document.createElement('div');
                row.id = `check-row-${i}`;
                let rowClass = "para-row grid grid-cols-2 text-xs min-h-[40px]";
                let viCellClass = "p-3 border-r border-slate-100 text-slate-700 leading-relaxed";
                let enCellClass = "p-3 text-slate-600 leading-relaxed";

                if (!vi[i] || !en[i]) {
                    if (!vi[i]) viCellClass += " cell-empty font-bold";
                    if (!en[i]) enCellClass += " cell-empty font-bold";
                } else if (isSeparator(vi[i]) !== isSeparator(en[i])) {
                     rowClass += " bg-orange-50";
                     viCellClass += " text-orange-800";
                     enCellClass += " text-orange-800";
                }

                row.className = rowClass;
                row.innerHTML = `
                    <div class="${viCellClass}"><span class="idx text-slate-400 font-mono text-[10px] mr-2 select-none">${i+1}</span>${vi[i] || '‚ùå (TR·ªêNG)'}</div>
                    <div class="${enCellClass}">${en[i] || '‚ùå (TR·ªêNG)'}</div>
                `;
                row.onclick = () => highlightAndScroll(i);
                container.appendChild(row);
            }
        }

        function highlightAndScroll(index) {
            // 1. Highlight Row
            document.querySelectorAll('.row-active').forEach(el => el.classList.remove('row-active'));
            const row = document.getElementById(`check-row-${index}`);
            if (row) {
                row.classList.add('row-active');
                row.scrollIntoView({behavior: "smooth", block: "center"});
            }

            // 2. Scroll & Select Textarea (MAGIC IS HERE)
            scrollToPara('content-vi', index);
            scrollToPara('content-en', index);
        }

        function scrollToPara(id, index) {
            const el = document.getElementById(id);
            const text = el.value;
            let cursor = 0;
            let currentPara = 0;
            
            while (cursor < text.length) {
                // B·ªè qua kho·∫£ng tr·∫Øng/xu·ªëng d√≤ng ƒë·∫ßu
                while(cursor < text.length && /\s/.test(text[cursor])) cursor++;
                
                if (cursor >= text.length) break;

                const start = cursor;
                // T√¨m ƒëi·ªÉm k·∫øt th√∫c (xu·ªëng d√≤ng ti·∫øp theo)
                while(cursor < text.length && text[cursor] !== '\n') cursor++;
                const end = cursor;

                // N·∫øu ƒëo·∫°n c√≥ n·ªôi dung
                if (start < end) { 
                    if (currentPara === index) {
                        el.focus();
                        el.setSelectionRange(start, end);
                        
                        // Scroll trick: t·∫°o input gi·∫£ ho·∫∑c d√πng blur/focus
                        const fullVal = el.value;
                        el.value = fullVal.substring(0, end);
                        el.scrollTop = el.scrollHeight;
                        el.value = fullVal;
                        el.setSelectionRange(start, end);
                        return;
                    }
                    currentPara++;
                }
            }
        }

        // --- PUBLISH ---
        async function publishChapter() {
            const btn = document.getElementById('btn-publish');
            const msg = document.getElementById('status-msg');
            
            const folder = document.getElementById('story-folder').value;
            const parent = document.getElementById('story-parent').value;
            const num = document.getElementById('chap-num').value;
            const title = document.getElementById('chap-title').value;
            const viVal = document.getElementById('content-vi').value;
            const enVal = document.getElementById('content-en').value;
            const isBilingual = document.getElementById('bilingual-mode').checked;

            btn.innerText = "‚è≥ ƒêang ƒë·∫©y code...";
            btn.classList.add('opacity-50');

            try {
                const viP = splitParas(viVal);
                const enP = splitParas(enVal);
                let bodyHTML = "";

                if (!isBilingual) {
                    bodyHTML = viP.map(p => {
                        if (isSeparator(p)) return `<p style="text-align: center; margin: 3rem 0; font-size: 1.5rem; color: #ccc;">* * *</p>`;
                        return `<p style="margin-bottom: 1.5rem; text-indent: 2em;">${p}</p>`;
                    }).join('\n\n');
                } else {
                    for (let i = 0; i < viP.length; i++) {
                        if (isSeparator(viP[i])) {
                            bodyHTML += `<p style="text-align: center; margin: 3rem 0; font-size: 1.5rem; color: #ccc;">* * *</p>\n\n`;
                        } else {
                            bodyHTML += `<p class="lang-vi">${viP[i]}</p>\n`;
                            if (enP[i]) bodyHTML += `<p class="lang-en">${enP[i]}</p>\n\n`;
                        }
                    }
                }

                const chapSlug = num.toString().padStart(2, '0');
                const fileName = `chap-${chapSlug}.md`;
                const path = `truyen/${folder}/${fileName}`;
                const prev = (parseInt(num) - 1).toString().padStart(2, '0');
                const next = (parseInt(num) + 1).toString().padStart(2, '0');
                let themeColor = "#2980b9"; 
                if (folder.includes('boyfriend') || folder.includes('red-white')) themeColor = "#e74c3c";

                const fileContent = `---
layout: default
title: Ch∆∞∆°ng ${num}
description: "${title}"
parent: ${parent}
nav_order: ${num}
---

<div style="font-size: 0.9rem; color: #888; margin-bottom: 30px;">
  <a href="{{ site.baseurl }}/" style="text-decoration:none; color:#888;">Home</a> / 
  <a href="./" style="text-decoration:none; color:#888;">${parent}</a> / 
  <span style="color:${themeColor};">Ch∆∞∆°ng ${num}</span>
</div>

<div style="text-align: center; margin-bottom: 40px;">
    <h1 style="color: #2c3e50; margin-bottom: 10px; font-size: 2rem;">CH∆Ø∆†NG ${num}</h1>
    <h2 style="font-size: 1.2rem; color: #7f8c8d; font-weight: normal; margin-top: 0;">${title}</h2>
</div>

<hr style="border: 0; border-top: 1px solid #eee; margin: 30px 0;">

<div class="chapter-content" style="line-height: 1.8; font-size: 1.1rem; color: #333; max-width: 800px; margin: 0 auto;">

${bodyHTML}

</div>

<nav style="display: flex; justify-content: space-between; align-items: center; padding: 2rem 0; margin-top: 3rem; border-top: 2px solid #eee;">
  <a href="./chap-${prev}" style="text-decoration: none; padding: 0.75rem 1.5rem; background: linear-gradient(135deg, ${themeColor} 0%, #2c3e50 100%); border-radius: 8px; color: white; font-weight: 600; transition: transform 0.2s;">
    ‚Üê Ch∆∞∆°ng tr∆∞·ªõc
  </a>
  <a href="./chap-${next}" style="text-decoration: none; padding: 0.75rem 1.5rem; background: linear-gradient(135deg, ${themeColor} 0%, #2c3e50 100%); border-radius: 8px; color: white; font-weight: 600; transition: transform 0.2s;">
    Ch∆∞∆°ng ti·∫øp ‚Üí
  </a>
</nav>
`;
                const contentBase64 = btoa(unescape(encodeURIComponent(fileContent)));
                const apiUrl = `https://api.github.com/repos/${config.user}/${config.repo}/contents/${path}`;
                let sha = null;
                try {
                    const c = await fetch(apiUrl, { headers: { 'Authorization': `token ${config.token}` }});
                    if(c.ok) { const d = await c.json(); sha = d.sha; }
                } catch(e){}

                const res = await fetch(apiUrl, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${config.token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: `Dashboard V7: Up ${fileName}`,
                        content: contentBase64,
                        sha: sha
                    })
                });

                if(res.ok) {
                    msg.innerHTML = `<span class="text-green-600 font-bold">‚úÖ Xong!</span> <a href="https://github.com/${config.user}/${config.repo}/blob/master/${path}" target="_blank" class="underline">Xem file</a>`;
                    document.getElementById('content-vi').value = '';
                    document.getElementById('content-en').value = '';
                    document.getElementById('chap-num').value = parseInt(num) + 1;
                    handleInput();
                } else {
                    throw new Error((await res.json()).message);
                }
            } catch(e) {
                alert(e.message);
            } finally {
                btn.innerText = "üöÄ ƒêƒÉng";
                btn.classList.remove('opacity-50');
            }
        }

        // Init
        document.getElementById('bilingual-mode').addEventListener('change', (e) => {
            const colEn = document.getElementById('col-en');
            if (e.target.checked) {
                colEn.classList.remove('hidden');
                document.getElementById('input-grid').classList.add('md:grid-cols-2');
            } else {
                colEn.classList.add('hidden');
                document.getElementById('input-grid').classList.remove('md:grid-cols-2');
            }
            handleInput();
        });
        document.getElementById('story-folder').addEventListener('change', (e) => {
            const map = {
                'boyfriend-material': 'Boyfriend Material',
                'the-long-game': 'The Long Game',
                'the-foxhole-court': 'The Foxhole Court',
                'the-wolf-at-the-door': 'The Wolf at the Door',
                'red-white-and-royal-blue': 'Red, White & Royal Blue'
            };
            document.getElementById('story-parent').value = map[e.target.value] || "";
        });

        checkAuth();
    </script>
</body>
</html>