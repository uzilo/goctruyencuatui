<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard V3 - G√≥c Truy·ªán C·ªßa Tui</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/slugify@1.6.6/slugify.min.js"></script>
    <style>
        .loading { opacity: 0.5; pointer-events: none; }
        /* Hi·ªáu ·ª©ng khi soi l·ªói */
        .para-item { transition: all 0.2s; cursor: pointer; }
        .para-item:hover { background-color: #f3f4f6; }
        .para-active { background-color: #dbeafe !important; border-color: #2563eb !important; transform: scale(1.01); }
        .para-error { background-color: #fee2e2 !important; border-color: #dc2626 !important; }
        /* Thanh cu·ªôn ƒë·∫πp */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4 md:p-6">

    <div class="max-w-7xl mx-auto bg-white rounded-xl shadow-lg p-6 md:p-8">
        <div class="flex justify-between items-center mb-8 border-b pb-4">
            <h1 class="text-3xl font-bold text-gray-800 flex items-center gap-2">
                üëë Dashboard <span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded">V3.0</span>
            </h1>
            <button onclick="logout()" class="text-sm text-red-500 hover:underline">ƒêƒÉng xu·∫•t</button>
        </div>

        <div id="config-section" class="mb-6 hidden">
            <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-200 mb-4 text-sm">
                üí° C·∫ßn <strong>Personal Access Token</strong> (Quy·ªÅn: <code>public_repo</code>).
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <input type="text" id="gh-username" class="p-2 border rounded" placeholder="GitHub Username">
                <input type="text" id="gh-repo" class="p-2 border rounded" placeholder="Repo Name">
                <input type="password" id="gh-token" class="p-2 border rounded" placeholder="GitHub Token (ghp_...)">
            </div>
            <button onclick="saveConfig()" class="mt-4 bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700 w-full">L∆∞u C·∫•u H√¨nh</button>
        </div>

        <div id="editor-section" class="hidden">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4 bg-gray-50 p-4 rounded-lg">
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Th∆∞ m·ª•c truy·ªán</label>
                    <select id="story-folder" class="w-full p-2 border rounded bg-white">
                        <option value="boyfriend-material">Boyfriend Material</option>
                        <option value="the-long-game">The Long Game</option>
                        <option value="the-foxhole-court">The Foxhole Court</option>
                        <option value="the-wolf-at-the-door">The Wolf at the Door</option>
                        <option value="red-white-and-royal-blue">Red, White & Royal Blue</option>
                    </select>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">T√™n truy·ªán (Parent)</label>
                    <input type="text" id="story-parent" class="w-full p-2 border rounded" placeholder="T√™n truy·ªán...">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">S·ªë Ch∆∞∆°ng</label>
                    <input type="number" id="chap-num" class="w-full p-2 border rounded" placeholder="1">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">T√™n Ch∆∞∆°ng</label>
                    <input type="text" id="chap-title" class="w-full p-2 border rounded" placeholder="Ti√™u ƒë·ªÅ...">
                </div>
            </div>

            <div class="flex flex-wrap items-center justify-between mb-4 gap-4">
                <label class="inline-flex items-center cursor-pointer select-none bg-blue-50 px-4 py-2 rounded-lg border border-blue-200">
                    <input type="checkbox" id="bilingual-mode" class="sr-only peer" checked>
                    <div class="w-11 h-6 bg-gray-200 rounded-full peer peer-checked:bg-blue-600 relative after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:after:translate-x-full"></div>
                    <span class="ml-3 text-sm font-bold text-gray-700">Ch·∫ø ƒë·ªô Song Ng·ªØ</span>
                </label>

                <button onclick="toggleChecker()" id="btn-checker" class="hidden md:inline-flex items-center gap-2 bg-purple-100 text-purple-700 px-4 py-2 rounded-lg hover:bg-purple-200 border border-purple-200 font-bold transition">
                    üîç Soi L·ªói & Kh·ªõp D√≤ng
                </button>
            </div>

            <div id="error-box" class="hidden mb-4 p-3 bg-red-100 text-red-800 border border-red-200 rounded text-sm font-semibold"></div>

            <div id="checker-area" class="hidden mb-6 border-2 border-purple-200 rounded-xl overflow-hidden bg-purple-50">
                <div class="p-3 bg-purple-100 border-b border-purple-200 flex justify-between items-center">
                    <span class="font-bold text-purple-800">üßê Ch·∫ø ƒë·ªô ki·ªÉm tra kh·ªõp d√≤ng</span>
                    <button onclick="toggleChecker()" class="text-xs bg-white px-2 py-1 rounded border hover:bg-gray-100">ƒê√≥ng</button>
                </div>
                <div class="grid grid-cols-2 h-[500px]">
                    <div id="check-vi" class="overflow-y-auto p-4 border-r border-purple-200 space-y-2"></div>
                    <div id="check-en" class="overflow-y-auto p-4 space-y-2"></div>
                </div>
                <div class="p-2 bg-purple-50 text-xs text-center text-gray-500 border-t border-purple-200">
                    *B·∫•m v√†o m·ªôt ƒëo·∫°n ƒë·ªÉ highlight ƒëo·∫°n t∆∞∆°ng ·ª©ng b√™n kia
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4" id="input-grid">
                <div class="flex flex-col h-full">
                    <div class="flex justify-between mb-1 items-end">
                        <label class="font-bold text-blue-700">üáªüá≥ Ti·∫øng Vi·ªát</label>
                        <span class="text-xs font-mono text-gray-500 bg-gray-100 px-2 py-1 rounded" id="count-vi">0 ƒëo·∫°n</span>
                    </div>
                    <textarea id="content-vi" class="w-full h-[500px] p-4 border border-gray-300 rounded-lg text-sm font-mono focus:ring-2 focus:ring-blue-500 outline-none resize-none shadow-sm" 
                    placeholder="D√°n n·ªôi dung Ti·∫øng Vi·ªát v√†o ƒë√¢y..." oninput="handleInput()"></textarea>
                </div>
                
                <div id="col-en" class="flex flex-col h-full">
                    <div class="flex justify-between mb-1 items-end">
                        <label class="font-bold text-red-700">üá∫üá∏ Ti·∫øng Anh</label>
                        <span class="text-xs font-mono text-gray-500 bg-gray-100 px-2 py-1 rounded" id="count-en">0 ƒëo·∫°n</span>
                    </div>
                    <textarea id="content-en" class="w-full h-[500px] p-4 border border-gray-300 rounded-lg text-sm font-mono focus:ring-2 focus:ring-red-500 outline-none resize-none shadow-sm" 
                    placeholder="Paste English text here..." oninput="handleInput()"></textarea>
                </div>
            </div>

            <button id="btn-publish" onclick="publishChapter()" class="w-full bg-gray-400 text-white font-bold text-xl py-4 rounded-lg shadow-lg transition transform active:scale-[0.99] mt-4" disabled>
                üöÄ ƒêƒÇNG CH∆Ø∆†NG L√äN GITHUB
            </button>
            <div id="status-msg" class="text-center mt-4 text-sm font-mono"></div>
        </div>
    </div>

    <script>
        const CONFIG_KEY = 'gh_admin_config_v3';
        let config = JSON.parse(localStorage.getItem(CONFIG_KEY)) || {};

        // --- AUTH ---
        function checkAuth() {
            const elConfig = document.getElementById('config-section');
            const elEditor = document.getElementById('editor-section');
            
            if (config.token && config.user && config.repo) {
                elConfig.classList.add('hidden');
                elEditor.classList.remove('hidden');
                handleInput(); // Run validation on load
            } else {
                elConfig.classList.remove('hidden');
                elEditor.classList.add('hidden');
            }
        }

        function saveConfig() {
            const user = document.getElementById('gh-username').value.trim();
            const repo = document.getElementById('gh-repo').value.trim();
            const token = document.getElementById('gh-token').value.trim();
            if(!user || !repo || !token) return alert("Nh·∫≠p ƒë·ªß th√¥ng tin ƒëi b·ªì!");
            config = { user, repo, token };
            localStorage.setItem(CONFIG_KEY, JSON.stringify(config));
            checkAuth();
        }

        function logout() {
            if(confirm("ƒêƒÉng xu·∫•t?")) {
                localStorage.removeItem(CONFIG_KEY);
                location.reload();
            }
        }

        // --- HELPERS ---
        function splitParas(text) {
            // T√°ch b·∫±ng xu·ªëng d√≤ng, lo·∫°i b·ªè d√≤ng tr·ªëng
            return text.split(/\n+/).map(p => p.trim()).filter(p => p.length > 0);
        }

        // --- LOGIC CH√çNH ---
        function handleInput() {
            const viVal = document.getElementById('content-vi').value;
            const enVal = document.getElementById('content-en').value;
            const isBilingual = document.getElementById('bilingual-mode').checked;
            
            const parasVi = splitParas(viVal);
            const parasEn = splitParas(enVal);
            
            // Update ƒë·∫øm s·ªë
            document.getElementById('count-vi').innerText = `${parasVi.length} ƒëo·∫°n`;
            document.getElementById('count-en').innerText = `${parasEn.length} ƒëo·∫°n`;

            // Validation
            const btn = document.getElementById('btn-publish');
            const errBox = document.getElementById('error-box');
            const btnChecker = document.getElementById('btn-checker');

            let isValid = false;
            let errorMsg = "";

            if (isBilingual) {
                // Ch·∫ø ƒë·ªô Song Ng·ªØ: B·∫Øt bu·ªôc 2 b√™n ph·∫£i b·∫±ng nhau
                btnChecker.classList.remove('hidden'); // Hi·ªán n√∫t soi l·ªói
                if (parasVi.length === 0 && parasEn.length === 0) {
                    errorMsg = ""; // Ch∆∞a nh·∫≠p g√¨
                } else if (parasVi.length !== parasEn.length) {
                    const diff = Math.abs(parasVi.length - parasEn.length);
                    errorMsg = `‚õî <strong>L·ªÜCH D√íNG:</strong> Vi·ªát (${parasVi.length}) ‚â† Anh (${parasEn.length}). L·ªách <b>${diff}</b> ƒëo·∫°n.`;
                } else {
                    isValid = true;
                }
            } else {
                // Ch·∫ø ƒë·ªô 1 Ng√¥n Ng·ªØ
                btnChecker.classList.add('hidden'); // ·∫®n n√∫t soi l·ªói
                if (parasVi.length > 0) isValid = true;
            }

            // UI Update
            if (errorMsg) {
                errBox.classList.remove('hidden');
                errBox.innerHTML = errorMsg;
                document.getElementById('count-vi').classList.add('text-red-600', 'font-bold');
                document.getElementById('count-en').classList.add('text-red-600', 'font-bold');
            } else {
                errBox.classList.add('hidden');
                document.getElementById('count-vi').classList.remove('text-red-600', 'font-bold');
                document.getElementById('count-en').classList.remove('text-red-600', 'font-bold');
            }

            if (isValid) {
                btn.disabled = false;
                btn.classList.remove('bg-gray-400', 'cursor-not-allowed');
                btn.classList.add('bg-green-600', 'hover:bg-green-700');
            } else {
                btn.disabled = true;
                btn.classList.remove('bg-green-600', 'hover:bg-green-700');
                btn.classList.add('bg-gray-400', 'cursor-not-allowed');
            }
        }

        // --- T√çNH NƒÇNG SOI L·ªñI ---
        function toggleChecker() {
            const area = document.getElementById('checker-area');
            const isHidden = area.classList.contains('hidden');
            
            if (isHidden) {
                area.classList.remove('hidden');
                renderChecker();
            } else {
                area.classList.add('hidden');
            }
        }

        function renderChecker() {
            const vi = splitParas(document.getElementById('content-vi').value);
            const en = splitParas(document.getElementById('content-en').value);
            
            const boxVi = document.getElementById('check-vi');
            const boxEn = document.getElementById('check-en');
            boxVi.innerHTML = "";
            boxEn.innerHTML = "";

            const max = Math.max(vi.length, en.length);

            for (let i = 0; i < max; i++) {
                // T·∫°o block ti·∫øng Vi·ªát
                const divVi = document.createElement('div');
                divVi.className = `para-item p-2 rounded border text-xs ${!vi[i] ? 'para-error' : 'border-gray-200 bg-white'}`;
                divVi.innerHTML = `<span class="font-bold text-blue-600 mr-1">${i+1}.</span> ${vi[i] ? vi[i].substring(0, 80) + '...' : '‚ùå (TR·ªêNG)'}`;
                divVi.dataset.idx = i;
                divVi.onclick = () => highlightPair(i);
                boxVi.appendChild(divVi);

                // T·∫°o block ti·∫øng Anh
                const divEn = document.createElement('div');
                divEn.className = `para-item p-2 rounded border text-xs ${!en[i] ? 'para-error' : 'border-gray-200 bg-white'}`;
                divEn.innerHTML = `<span class="font-bold text-red-600 mr-1">${i+1}.</span> ${en[i] ? en[i].substring(0, 80) + '...' : '‚ùå (TR·ªêNG)'}`;
                divEn.dataset.idx = i;
                divEn.onclick = () => highlightPair(i);
                boxEn.appendChild(divEn);
            }
        }

        function highlightPair(idx) {
            // X√≥a highlight c≈©
            document.querySelectorAll('.para-active').forEach(el => el.classList.remove('para-active'));
            
            // Th√™m highlight m·ªõi
            const v = document.querySelector(`#check-vi div[data-idx='${idx}']`);
            const e = document.querySelector(`#check-en div[data-idx='${idx}']`);
            
            if(v) {
                v.classList.add('para-active');
                v.scrollIntoView({behavior: "smooth", block: "center"});
            }
            if(e) {
                e.classList.add('para-active');
                e.scrollIntoView({behavior: "smooth", block: "center"});
            }
        }

        // --- PUBLISH ---
        function generateBodyHTML(viVal, enVal, isBilingual) {
            const viP = splitParas(viVal);
            
            if (!isBilingual) {
                // Ch·∫ø ƒë·ªô 1 ng√¥n ng·ªØ: Format ƒë·∫πp chu·∫©n s√°ch
                return viP.map(p => {
                    if (/^(\*\s*){3,}$/.test(p)) return `<p style="text-align: center; margin: 3rem 0; font-size: 1.5rem; color: #ccc;">* * *</p>`;
                    return `<p style="margin-bottom: 1.5rem; text-indent: 2em;">${p}</p>`;
                }).join('\n\n');
            }

            // Ch·∫ø ƒë·ªô Song ng·ªØ
            const enP = splitParas(enVal);
            let html = "";
            
            for (let i = 0; i < viP.length; i++) {
                const isSeparator = /^(\*\s*){3,}$/.test(viP[i]) || (enP[i] && /^(\*\s*){3,}$/.test(enP[i]));
                
                if (isSeparator) {
                    html += `<p style="text-align: center; margin: 3rem 0; font-size: 1.5rem; color: #ccc;">* * *</p>\n\n`;
                } else {
                    html += `<p class="lang-vi">${viP[i]}</p>\n`;
                    if (enP[i]) html += `<p class="lang-en">${enP[i]}</p>\n\n`;
                }
            }
            return html;
        }

        async function publishChapter() {
            const btn = document.getElementById('btn-publish');
            const msg = document.getElementById('status-msg');
            
            const folder = document.getElementById('story-folder').value;
            const parent = document.getElementById('story-parent').value;
            const num = document.getElementById('chap-num').value;
            const title = document.getElementById('chap-title').value;
            const viVal = document.getElementById('content-vi').value;
            const enVal = document.getElementById('content-en').value;
            const isBilingual = document.getElementById('bilingual-mode').checked;

            btn.innerText = "‚è≥ ƒêang x·ª≠ l√Ω...";
            btn.classList.add('opacity-50');
            
            try {
                const bodyHTML = generateBodyHTML(viVal, enVal, isBilingual);
                
                const chapSlug = num.toString().padStart(2, '0');
                const fileName = `chap-${chapSlug}.md`;
                const path = `truyen/${folder}/${fileName}`;
                const prev = (parseInt(num) - 1).toString().padStart(2, '0');
                const next = (parseInt(num) + 1).toString().padStart(2, '0');

                // M√†u s·∫Øc theo truy·ªán
                let themeColor = "#2980b9"; // M·∫∑c ƒë·ªãnh xanh d∆∞∆°ng
                if (folder.includes('boyfriend') || folder.includes('red-white')) themeColor = "#e74c3c"; // ƒê·ªè cam

                const fileContent = `---
layout: default
title: Ch∆∞∆°ng ${num}
description: "${title}"
parent: ${parent}
nav_order: ${num}
---

<div style="font-size: 0.9rem; color: #888; margin-bottom: 30px;">
  <a href="{{ site.baseurl }}/" style="text-decoration:none; color:#888;">Home</a> / 
  <a href="./" style="text-decoration:none; color:#888;">${parent}</a> / 
  <span style="color:${themeColor};">Ch∆∞∆°ng ${num}</span>
</div>

<div style="text-align: center; margin-bottom: 40px;">
    <h1 style="color: #2c3e50; margin-bottom: 10px; font-size: 2rem;">CH∆Ø∆†NG ${num}</h1>
    <h2 style="font-size: 1.2rem; color: #7f8c8d; font-weight: normal; margin-top: 0;">${title}</h2>
</div>

<hr style="border: 0; border-top: 1px solid #eee; margin: 30px 0;">

<div class="chapter-content" style="line-height: 1.8; font-size: 1.1rem; color: #333; max-width: 800px; margin: 0 auto;">

${bodyHTML}

</div>

<nav style="display: flex; justify-content: space-between; align-items: center; padding: 2rem 0; margin-top: 3rem; border-top: 2px solid #eee;">
  <a href="./chap-${prev}" style="text-decoration: none; padding: 0.75rem 1.5rem; background: linear-gradient(135deg, ${themeColor} 0%, #2c3e50 100%); border-radius: 8px; color: white; font-weight: 600; transition: transform 0.2s;">
    ‚Üê Ch∆∞∆°ng tr∆∞·ªõc
  </a>
  <a href="./chap-${next}" style="text-decoration: none; padding: 0.75rem 1.5rem; background: linear-gradient(135deg, ${themeColor} 0%, #2c3e50 100%); border-radius: 8px; color: white; font-weight: 600; transition: transform 0.2s;">
    Ch∆∞∆°ng ti·∫øp ‚Üí
  </a>
</nav>
`;
                // G·ª≠i API
                const contentBase64 = btoa(unescape(encodeURIComponent(fileContent)));
                const apiUrl = `https://api.github.com/repos/${config.user}/${config.repo}/contents/${path}`;

                let sha = null;
                try {
                    const c = await fetch(apiUrl, { headers: { 'Authorization': `token ${config.token}` }});
                    if(c.ok) { const d = await c.json(); sha = d.sha; }
                } catch(e){}

                const res = await fetch(apiUrl, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${config.token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: `Dashboard: Up ch∆∞∆°ng ${num} [${isBilingual ? 'Song Ng·ªØ' : 'Ti·∫øng Vi·ªát'}]`,
                        content: contentBase64,
                        sha: sha
                    })
                });

                if(res.ok) {
                    msg.innerHTML = `<span class="text-green-600 font-bold text-lg">‚úÖ ƒê√£ ƒëƒÉng th√†nh c√¥ng!</span><br><a href="https://github.com/${config.user}/${config.repo}/blob/master/${path}" target="_blank" class="underline text-blue-600">Xem file tr√™n GitHub</a>`;
                    
                    // T·ª± ƒë·ªông reset form
                    document.getElementById('content-vi').value = '';
                    document.getElementById('content-en').value = '';
                    document.getElementById('chap-num').value = parseInt(num) + 1;
                    
                    // ·∫®n checker n·∫øu ƒëang m·ªü
                    document.getElementById('checker-area').classList.add('hidden');
                    handleInput();
                } else {
                    const err = await res.json();
                    throw new Error(err.message);
                }

            } catch(e) {
                alert(e.message);
                msg.innerText = "‚ùå L·ªói: " + e.message;
            } finally {
                btn.innerText = "üöÄ ƒêƒÇNG CH∆Ø∆†NG L√äN GITHUB";
                btn.classList.remove('opacity-50');
            }
        }

        // --- S·ª∞ KI·ªÜN ---
        document.getElementById('bilingual-mode').addEventListener('change', (e) => {
            const colEn = document.getElementById('col-en');
            if (e.target.checked) {
                colEn.classList.remove('hidden');
                document.getElementById('input-grid').classList.remove('grid-cols-1');
                document.getElementById('input-grid').classList.add('md:grid-cols-2');
            } else {
                colEn.classList.add('hidden');
                document.getElementById('input-grid').classList.add('grid-cols-1');
                document.getElementById('input-grid').classList.remove('md:grid-cols-2');
            }
            handleInput();
        });

        document.getElementById('story-folder').addEventListener('change', (e) => {
            const map = {
                'boyfriend-material': 'Boyfriend Material',
                'the-long-game': 'The Long Game',
                'the-foxhole-court': 'The Foxhole Court',
                'the-wolf-at-the-door': 'The Wolf at the Door',
                'red-white-and-royal-blue': 'Red, White & Royal Blue'
            };
            document.getElementById('story-parent').value = map[e.target.value] || "";
        });

        // Init
        checkAuth();
    </script>
</body>
</html>