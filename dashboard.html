<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - G√≥c Truy·ªán C·ªßa Tui</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .loading { opacity: 0.5; pointer-events: none; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-6">

    <div class="max-w-6xl mx-auto bg-white rounded-xl shadow-lg p-8">
        <div class="flex justify-between items-center mb-8 border-b pb-4">
            <h1 class="text-3xl font-bold text-gray-800">üëë Admin Dashboard - Song Ng·ªØ</h1>
            <button onclick="logout()" class="text-sm text-red-500 hover:underline">ƒêƒÉng xu·∫•t</button>
        </div>

        <div id="config-section" class="mb-6 hidden">
            <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-200 mb-4">
                <p class="text-sm text-yellow-800">üí° C·∫ßn <strong>Personal Access Token</strong> (Quy·ªÅn: <code>public_repo</code> ho·∫∑c <code>repo</code>).</p>
            </div>
            <div class="grid grid-cols-3 gap-4">
                <input type="text" id="gh-username" class="p-2 border rounded" placeholder="GitHub Username (vd: TrieuLM-2)">
                <input type="text" id="gh-repo" class="p-2 border rounded" placeholder="Repo Name (vd: goctruyencuatui)">
                <input type="password" id="gh-token" class="p-2 border rounded" placeholder="GitHub Token (ghp_...)">
            </div>
            <button onclick="saveConfig()" class="mt-4 bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700 w-full">L∆∞u C·∫•u H√¨nh</button>
        </div>

        <div id="editor-section" class="hidden">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-bold mb-1">Th∆∞ m·ª•c truy·ªán:</label>
                    <select id="story-folder" class="w-full p-2 border rounded bg-gray-50">
                        <option value="the-long-game">The Long Game</option>
                        <option value="boyfriend-material">Boyfriend Material</option>
                        <option value="the-foxhole-court">The Foxhole Court</option>
                        <option value="the-wolf-at-the-door">The Wolf at the Door</option>
                        <option value="red-white-and-royal-blue">Red, White & Royal Blue</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-bold mb-1">T√™n truy·ªán (Parent):</label>
                    <input type="text" id="story-parent" class="w-full p-2 border rounded" value="The Long Game">
                </div>
                <div>
                    <label class="block text-sm font-bold mb-1">S·ªë Ch∆∞∆°ng:</label>
                    <input type="number" id="chap-num" class="w-full p-2 border rounded" placeholder="1">
                </div>
                <div>
                    <label class="block text-sm font-bold mb-1">T√™n Ch∆∞∆°ng:</label>
                    <input type="text" id="chap-title" class="w-full p-2 border rounded" placeholder="Ti√™u ƒë·ªÅ ch∆∞∆°ng...">
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4 mb-4" id="bilingual-container">
                <div>
                    <div class="flex justify-between mb-1">
                        <label class="font-bold text-blue-700">üáªüá≥ Ti·∫øng Vi·ªát</label>
                        <span class="text-xs text-gray-500" id="count-vi">0 ƒëo·∫°n</span>
                    </div>
                    <textarea id="content-vi" class="w-full h-[500px] p-3 border border-blue-200 rounded text-sm font-mono focus:ring-2 focus:ring-blue-500 outline-none" 
                    placeholder="D√°n n·ªôi dung Ti·∫øng Vi·ªát v√†o ƒë√¢y.&#10;M·ªói ƒëo·∫°n vƒÉn c√°ch nhau b·ªüi d·∫•u xu·ªëng d√≤ng (Enter)." oninput="countParas()"></textarea>
                </div>
                <div>
                    <div class="flex justify-between mb-1">
                        <label class="font-bold text-red-700">üá∫üá∏ Ti·∫øng Anh</label>
                        <span class="text-xs text-gray-500" id="count-en">0 ƒëo·∫°n</span>
                    </div>
                    <textarea id="content-en" class="w-full h-[500px] p-3 border border-red-200 rounded text-sm font-mono focus:ring-2 focus:ring-red-500 outline-none" 
                    placeholder="Paste English content here.&#10;Make sure the number of paragraphs matches the Vietnamese side." oninput="countParas()"></textarea>
                </div>
            </div>

            <button id="btn-publish" onclick="publishChapter()" class="w-full bg-green-600 text-white font-bold text-xl py-4 rounded-lg shadow hover:bg-green-700 transition transform active:scale-[0.99]">
                üöÄ TR·ªòN & ƒêƒÇNG L√äN GITHUB
            </button>
            <div id="status-msg" class="text-center mt-4 text-sm font-mono"></div>
        </div>
    </div>

    <script>
        // --- 1. C·∫§U H√åNH & AUTH ---
        const CONFIG_KEY = 'gh_admin_config';
        let config = JSON.parse(localStorage.getItem(CONFIG_KEY)) || {};

        function checkAuth() {
            if (config.token && config.user && config.repo) {
                document.getElementById('config-section').classList.add('hidden');
                document.getElementById('editor-section').classList.remove('hidden');
            } else {
                document.getElementById('config-section').classList.remove('hidden');
                document.getElementById('editor-section').classList.add('hidden');
            }
        }

        function saveConfig() {
            const user = document.getElementById('gh-username').value.trim();
            const repo = document.getElementById('gh-repo').value.trim();
            const token = document.getElementById('gh-token').value.trim();
            if(!user || !repo || !token) return alert("Nh·∫≠p ƒë·ªß th√¥ng tin ƒëi b·ªì!");
            config = { user, repo, token };
            localStorage.setItem(CONFIG_KEY, JSON.stringify(config));
            checkAuth();
        }

        function logout() {
            if(confirm("ƒêƒÉng xu·∫•t v√† x√≥a c·∫•u h√¨nh?")) {
                localStorage.removeItem(CONFIG_KEY);
                location.reload();
            }
        }

        // --- 2. X·ª¨ L√ù VƒÇN B·∫¢N (CORE LOGIC) ---
        
        function splitParagraphs(text) {
            // T√°ch d·ª±a tr√™n k√Ω t·ª± xu·ªëng d√≤ng (\n). 
            // filter(p => p.trim()) ƒë·ªÉ lo·∫°i b·ªè c√°c d√≤ng tr·ªëng v√¥ nghƒ©a.
            return text.split(/\n+/).map(p => p.trim()).filter(p => p.length > 0);
        }

        function countParas() {
            const viTxt = document.getElementById('content-vi').value;
            const enTxt = document.getElementById('content-en').value;
            const cVi = splitParagraphs(viTxt).length;
            const cEn = splitParagraphs(enTxt).length;
            
            document.getElementById('count-vi').innerText = `${cVi} ƒëo·∫°n`;
            
            const elEn = document.getElementById('count-en');
            elEn.innerText = `${cEn} ƒëo·∫°n`;
            
            // C·∫£nh b√°o n·∫øu s·ªë ƒëo·∫°n kh√¥ng kh·ªõp
            if(cVi !== cEn && cEn > 0) {
                elEn.className = "text-xs text-red-600 font-bold blink";
                elEn.innerText += " (‚ö†Ô∏è L·ªách!)";
            } else {
                elEn.className = "text-xs text-gray-500";
            }
        }

        function generateHTML(viVal, enVal) {
            const viParas = splitParagraphs(viVal);
            const enParas = splitParagraphs(enVal);
            
            let html = "";
            const max = Math.max(viParas.length, enParas.length);

            for (let i = 0; i < max; i++) {
                // ƒêo·∫°n Ti·∫øng Vi·ªát
                if (viParas[i]) {
                    html += `<p class="lang-vi">${viParas[i]}</p>\n`;
                }
                // ƒêo·∫°n Ti·∫øng Anh
                if (enParas[i]) {
                    html += `<p class="lang-en">${enParas[i]}</p>\n`;
                }
                // Th√™m d√≤ng tr·ªëng ƒë·ªÉ code nh√¨n tho√°ng
                html += "\n";
            }
            return html;
        }

        // --- 3. ƒê·∫®Y L√äN GITHUB ---
        async function publishChapter() {
            const btn = document.getElementById('btn-publish');
            const msg = document.getElementById('status-msg');
            
            const folder = document.getElementById('story-folder').value;
            const parent = document.getElementById('story-parent').value;
            const num = document.getElementById('chap-num').value;
            const title = document.getElementById('chap-title').value;
            const viVal = document.getElementById('content-vi').value;
            const enVal = document.getElementById('content-en').value;

            if(!num || !title) return alert("Nh·∫≠p s·ªë ch∆∞∆°ng v√† t√™n ch∆∞∆°ng ƒëi b·ªì!");
            if(!viVal) return alert("Ch∆∞a c√≥ n·ªôi dung truy·ªán!");

            btn.classList.add('loading');
            btn.innerText = "‚è≥ ƒêang x·ª≠ l√Ω...";
            msg.innerHTML = '<span class="text-blue-500">ƒêang tr·ªôn vƒÉn b·∫£n v√† k·∫øt n·ªëi GitHub...</span>';

            try {
                // 1. T·∫°o n·ªôi dung HTML
                const bodyHTML = generateHTML(viVal, enVal);

                // 2. T·∫°o n·ªôi dung file Markdown ho√†n ch·ªânh
                const chapSlug = num.toString().padStart(2, '0');
                const fileName = `chap-${chapSlug}.md`;
                const prevSlug = (parseInt(num) - 1).toString().padStart(2, '0');
                const nextSlug = (parseInt(num) + 1).toString().padStart(2, '0');

                const fileContent = `---
layout: default
title: Ch∆∞∆°ng ${num}
description: "${title}"
parent: ${parent}
nav_order: ${num}
---

<div style="font-size: 0.9rem; color: #888; margin-bottom: 30px;">
  <a href="{{ site.baseurl }}/" style="text-decoration:none; color:#888;">Home</a> / 
  <a href="./" style="text-decoration:none; color:#888;">${parent}</a> / 
  <span style="color:#2980b9;">Ch∆∞∆°ng ${num}</span>
</div>

<div style="text-align: center; margin-bottom: 40px;">
    <h1 style="color: #2c3e50; margin-bottom: 10px; font-size: 2rem;">CH∆Ø∆†NG ${num}</h1>
    <h2 style="font-size: 1.2rem; color: #7f8c8d; font-weight: normal; margin-top: 0;">${title}</h2>
</div>

<hr style="border: 0; border-top: 1px solid #eee; margin: 30px 0;">

<div class="chapter-content" style="line-height: 1.8; font-size: 1.1rem; color: #333; max-width: 800px; margin: 0 auto;">

${bodyHTML}

</div>

<nav style="display: flex; justify-content: space-between; align-items: center; padding: 2rem 0; margin-top: 3rem; border-top: 2px solid #eee;">
  <a href="./chap-${prevSlug}" style="text-decoration: none; padding: 0.75rem 1.5rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 8px; color: white; font-weight: 600; transition: transform 0.2s;">
    ‚Üê Ch∆∞∆°ng tr∆∞·ªõc
  </a>
  <a href="./chap-${nextSlug}" style="text-decoration: none; padding: 0.75rem 1.5rem; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); border-radius: 8px; color: white; font-weight: 600; transition: transform 0.2s;">
    Ch∆∞∆°ng ti·∫øp ‚Üí
  </a>
</nav>
`;

                // 3. G·ª≠i API
                // X·ª≠ l√Ω Unicode cho btoa
                const contentBase64 = btoa(unescape(encodeURIComponent(fileContent)));
                const path = `truyen/${folder}/${fileName}`;
                const apiUrl = `https://api.github.com/repos/${config.user}/${config.repo}/contents/${path}`;

                // Check file t·ªìn t·∫°i ƒë·ªÉ l·∫•y SHA
                let sha = null;
                try {
                    const check = await fetch(apiUrl, { headers: { 'Authorization': `token ${config.token}` }});
                    if(check.ok) {
                        const data = await check.json();
                        sha = data.sha;
                    }
                } catch(e) {}

                // PUT request
                const res = await fetch(apiUrl, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${config.token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: `Dashboard: Up ch∆∞∆°ng ${num} - ${title}`,
                        content: contentBase64,
                        sha: sha
                    })
                });

                if(res.ok) {
                    msg.innerHTML = `‚úÖ <span class="text-green-600 font-bold">Th√†nh c√¥ng!</span> ƒê√£ t·∫°o file: <code>${path}</code><br>ƒê·ª£i 1-2 ph√∫t GitHub build nh√©.`;
                    // Clear input
                    document.getElementById('content-vi').value = '';
                    document.getElementById('content-en').value = '';
                    document.getElementById('chap-num').value = parseInt(num) + 1;
                    countParas(); // Reset ƒë·∫øm
                } else {
                    const err = await res.json();
                    throw new Error(err.message);
                }

            } catch(e) {
                alert("L·ªói: " + e.message);
                msg.innerText = "‚ùå L·ªói: " + e.message;
            } finally {
                btn.classList.remove('loading');
                btn.innerText = "üöÄ TR·ªòN & ƒêƒÇNG L√äN GITHUB";
            }
        }

        // Auto ƒëi·ªÅn t√™n truy·ªán khi ch·ªçn folder
        document.getElementById('story-folder').addEventListener('change', (e) => {
            const map = {
                'boyfriend-material': 'Boyfriend Material',
                'the-long-game': 'The Long Game',
                'the-foxhole-court': 'The Foxhole Court',
                'the-wolf-at-the-door': 'The Wolf at the Door',
                'red-white-and-royal-blue': 'Red, White & Royal Blue'
            };
            document.getElementById('story-parent').value = map[e.target.value] || "";
        });

        // Init
        checkAuth();
    </script>
</body>
</html>