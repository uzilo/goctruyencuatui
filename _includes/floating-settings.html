<div id="settings-bar" class="floating-settings">
  <button id="settings-toggle" class="settings-toggle" title="C√†i ƒë·∫∑t ƒë·ªçc">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path d="M12 15a3 3 0 1 0 0-6 3 3 0 0 0 0 6Z"/>
      <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1Z"/>
    </svg>
  </button>
  
  <div id="settings-panel" class="settings-panel">
    
    <div class="setting-group">
      <div class="setting-header">
        <span class="setting-icon">Aa</span>
        <span class="setting-title">Ki·ªÉu ch·ªØ</span>
      </div>
      <select id="font-selector" class="setting-input">
        <option value="'Nunito Sans', sans-serif">M·∫∑c ƒë·ªãnh (Nunito)</option>
        <option value="'Merriweather', serif">Merriweather (S√°ch b√°o)</option>
        <option value="'Lora', serif">Lora (Th∆° m·ªông)</option>
        <option value="'Roboto', sans-serif">Roboto (Hi·ªán ƒë·∫°i)</option>
        <option value="'Open Sans', sans-serif">Open Sans (D·ªÖ ƒë·ªçc)</option>
        <option value="'Patrick Hand', cursive">Patrick Hand (Vi·∫øt tay)</option>
        <option value="'Courier New', monospace">Courier New (M√°y ƒë√°nh ch·ªØ)</option>
      </select>
    </div>

    <div class="setting-group">
      <div class="setting-header">
        <span class="setting-icon">T</span>
        <span class="setting-title">C·ª° ch·ªØ: <span id="font-size-val">100%</span></span>
      </div>
      <div class="range-control">
        <button class="control-btn" onclick="adjustSize(-10)">-</button>
        <input type="range" id="font-size-range" min="80" max="200" value="100" step="10">
        <button class="control-btn" onclick="adjustSize(10)">+</button>
      </div>
    </div>

    <div class="setting-group">
      <div class="setting-header">
        <span class="setting-icon">‚Üï</span>
        <span class="setting-title">D√£n d√≤ng: <span id="line-height-val">1.8</span></span>
      </div>
      <input type="range" id="line-height-range" class="full-range" min="1.4" max="2.4" value="1.8" step="0.1">
    </div>

    <div class="setting-group">
      <div class="setting-header">
        <span class="setting-icon">üé®</span>
        <span class="setting-title">Giao di·ªán</span>
      </div>
      <div class="theme-options">
        <button class="theme-btn light active" onclick="setTheme('light')">‚òÄÔ∏è S√°ng</button>
        <button class="theme-btn sepia" onclick="setTheme('sepia')">üçÇ Sepia</button>
        <button class="theme-btn dark" onclick="setTheme('dark')">üåô T·ªëi</button>
      </div>
    </div>

    <button id="reset-btn" class="reset-btn">üîÑ ƒê·∫∑t l·∫°i m·∫∑c ƒë·ªãnh</button>
  </div>
</div>

<style>
  @import url('https://fonts.googleapis.com/css2?family=Merriweather:wght@300;400;700&family=Lora:wght@400;600&family=Roboto:wght@300;400;500&family=Open+Sans:wght@400;600&family=Patrick+Hand&display=swap');

  /* CSS Variables for global settings */
  :root {
    --reader-font-size: 100%;
    --reader-line-height: 1.8;
    --reader-font-family: 'Nunito Sans', sans-serif;
  }

  /* Apply settings to all text elements */
  body {
    font-size: var(--reader-font-size) !important;
    line-height: var(--reader-line-height) !important;
    font-family: var(--reader-font-family) !important;
  }

  .floating-settings {
    position: fixed;
    bottom: 30px;
    right: 30px;
    z-index: 9999;
    font-family: 'Nunito Sans', sans-serif;
  }

  .settings-toggle {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background: #159957;
    color: white;
    border: none;
    box-shadow: 0 4px 15px rgba(21, 153, 87, 0.4);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: transform 0.2s, background 0.2s;
  }
  .settings-toggle:hover {
    transform: rotate(45deg);
    background: #128249;
  }

  .settings-panel {
    position: absolute;
    bottom: 65px;
    right: 0;
    width: 280px;
    background: white;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 5px 25px rgba(0,0,0,0.2);
    display: none;
    opacity: 0;
    transform: translateY(10px);
    transition: opacity 0.3s, transform 0.3s;
  }
  .settings-panel.show {
    display: block;
    opacity: 1;
    transform: translateY(0);
  }

  .setting-group { margin-bottom: 15px; }
  
  .setting-header {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 8px;
    font-weight: 700;
    font-size: 0.9rem;
    color: #333;
  }
  .setting-icon { color: #159957; font-size: 1.1rem; }

  .setting-input {
    width: 100%;
    padding: 8px;
    border: 1px solid #ddd;
    border-radius: 6px;
    outline: none;
  }
  
  .range-control {
    display: flex;
    align-items: center;
    gap: 10px;
  }
  .full-range { width: 100%; }
  
  .control-btn {
    background: #eee;
    border: none;
    width: 30px;
    height: 30px;
    border-radius: 4px;
    cursor: pointer;
    font-weight: bold;
  }
  .control-btn:hover { background: #ddd; }

  .theme-options { display: flex; gap: 8px; }
  .theme-btn {
    flex: 1;
    border: 1px solid #ddd;
    background: #f9f9f9;
    padding: 8px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.85rem;
    font-weight: 600;
  }
  .theme-btn.active { border-color: #159957; color: #159957; background: #e8f5e9; }

  .reset-btn {
    width: 100%;
    margin-top: 10px;
    padding: 8px;
    background: none;
    border: 1px dashed #aaa;
    color: #666;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.85rem;
  }
  .reset-btn:hover { border-color: #d9534f; color: #d9534f; }

  /* Theme styles - √Åp d·ª•ng to√†n trang */
  body.dark-mode {
    background-color: #1a1a1a !important;
    color: #e0e0e0 !important;
  }

  body.sepia-mode {
    background-color: #f4ecd8 !important;
    color: #5c4b37 !important;
  }

  body.dark-mode .main-content,
  body.dark-mode article,
  body.dark-mode .content-container,
  body.dark-mode p {
    background-color: #2d2d2d !important;
    color: #e0e0e0 !important;
  }

  body.sepia-mode .main-content,
  body.sepia-mode article,
  body.sepia-mode .content-container,
  body.sepia-mode p {
    background-color: #f9f5e7 !important;
    color: #5c4b37 !important;
  }

  /* Dark mode support for settings panel */
  body.dark-mode .settings-panel {
    background-color: #2d2d2d;
    border: 1px solid #444;
    color: #eee;
  }
  body.dark-mode .setting-header { color: #eee; }
  body.dark-mode .setting-input, body.dark-mode .control-btn, body.dark-mode .theme-btn { 
    background: #444; color: white; border: none; 
  }
  body.dark-mode .reset-btn { color: #aaa; border-color: #666; }
</style>

<script>
document.addEventListener("DOMContentLoaded", function() {
  const panel = document.getElementById("settings-panel");
  const toggleBtn = document.getElementById("settings-toggle");
  
  // Toggle Panel
  toggleBtn.addEventListener("click", (e) => {
    e.stopPropagation();
    panel.classList.toggle("show");
  });

  document.addEventListener("click", (e) => {
    if (!panel.contains(e.target) && e.target !== toggleBtn) {
      panel.classList.remove("show");
    }
  });

  // Load Preferences
  const savedFont = localStorage.getItem("reader_font");
  const savedSize = localStorage.getItem("reader_size");
  const savedLine = localStorage.getItem("reader_line");
  const savedTheme = localStorage.getItem("reader_theme");

  if(savedFont) applyFont(savedFont);
  if(savedSize) applySize(savedSize);
  if(savedLine) applyLine(savedLine);
  if(savedTheme) setTheme(savedTheme);

  // Event Listeners
  document.getElementById("font-selector").addEventListener("change", function() { applyFont(this.value); });
  document.getElementById("font-size-range").addEventListener("input", function() { applySize(this.value); });
  document.getElementById("line-height-range").addEventListener("input", function() { applyLine(this.value); });

  document.getElementById("reset-btn").addEventListener("click", function() {
    applyFont("'Nunito Sans', sans-serif");
    applySize(100);
    applyLine(1.8);
    setTheme('light');
    
    document.getElementById("font-selector").value = "'Nunito Sans', sans-serif";
    document.getElementById("font-size-range").value = 100;
    document.getElementById("line-height-range").value = 1.8;
  });
});

// √ÅP D·ª§NG TO√ÄN TRANG - IMPROVED VERSION

function applyFont(font) {
  // √Åp d·ª•ng cho CSS variable ƒë·ªÉ to√†n b·ªô site k·∫ø th·ª´a
  document.documentElement.style.setProperty('--reader-font-family', font);
  document.body.style.setProperty('font-family', font, 'important');
  
  document.getElementById("font-selector").value = font; 
  localStorage.setItem("reader_font", font);
}

function applySize(size) {
  // S·ª≠ d·ª•ng CSS variable ƒë·ªÉ √°p d·ª•ng to√†n site
  document.documentElement.style.setProperty('--reader-font-size', size + '%');
  document.body.style.setProperty('font-size', size + '%', 'important');
  
  // √Åp d·ª•ng cho t·∫•t c·∫£ text elements
  const textElements = document.querySelectorAll('p, div, article, section, li, h1, h2, h3, h4, h5, h6, span, a, td, th, blockquote, pre, code');
  textElements.forEach(el => {
    if (!el.closest('.floating-settings')) { // Tr√°nh √°p d·ª•ng v√†o settings panel
      el.style.fontSize = 'inherit';
    }
  });
  
  document.getElementById("font-size-val").innerText = size + "%";
  document.getElementById("font-size-range").value = size;
  localStorage.setItem("reader_size", size);
}

function applyLine(height) {
  // S·ª≠ d·ª•ng CSS variable
  document.documentElement.style.setProperty('--reader-line-height', height);
  document.body.style.setProperty('line-height', height, 'important');
  
  // √Åp d·ª•ng cho to√†n b·ªô text elements
  const textElements = document.querySelectorAll('p, div, article, section, li, h1, h2, h3, h4, h5, h6, span, a, td, th, blockquote, pre');
  textElements.forEach(el => {
    if (!el.closest('.floating-settings')) { // Tr√°nh √°p d·ª•ng v√†o settings panel
      el.style.lineHeight = height;
    }
  });
  
  document.getElementById("line-height-val").innerText = height;
  document.getElementById("line-height-range").value = height;
  localStorage.setItem("reader_line", height);
}

function setTheme(theme) {
  // Theme √°p d·ª•ng to√†n trang (body)
  document.body.classList.remove("sepia-mode", "dark-mode");
  document.querySelectorAll(".theme-btn").forEach(btn => btn.classList.remove("active"));
  
  if (theme === 'sepia') {
    document.body.classList.add("sepia-mode");
    const sepiaBtn = document.querySelector(".theme-btn.sepia");
    if(sepiaBtn) sepiaBtn.classList.add("active");
  } else if (theme === 'dark') {
    document.body.classList.add("dark-mode");
    const darkBtn = document.querySelector(".theme-btn.dark");
    if(darkBtn) darkBtn.classList.add("active");
  } else {
    const lightBtn = document.querySelector(".theme-btn.light");
    if(lightBtn) lightBtn.classList.add("active");
  }
  
  localStorage.setItem("reader_theme", theme);
}

// H√†m h·ªó tr·ª£ n√∫t +/-
function adjustSize(amount) {
  let current = parseInt(document.getElementById("font-size-range").value);
  let newSize = current + amount;
  if(newSize >= 80 && newSize <= 200) {
    applySize(newSize);
  }
}
</script>